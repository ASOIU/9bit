---
layout: post
wp_id:  2244
title:  'Ускоряем .NET'
author: ZKyl
date:             2011-06-17 05:47:23 +0000
last_modified_at: 2013-11-19 13:58:17 +0000
redirect_from: 
  - /excerpt/2244.html
  - /2011/2244/
  - /2011/2244/ускоряем-net/
authors: 
  - Васильев Евгений
issues: 
  - (к изданию)
  - №9 июнь 2012
categories: 
  - Software
tags: 
  - .NET Framework
  - Microsoft
  - оптимизация
  - сисадмин
---
<p><img class="alignright noborder size-full wp-image-2260" src="{{ site.url }}{{ site.baseurl }}{% link /wp-content/uploads/2011/06/NET.gif %}" alt=".NET logo" width="117" height="111" />Вместе с .NET Framework в систему ставятся службы <strong>.NET Runtime Optimization Service</strong>, задача которых состоит в кэшировании и сборке нативных приложений из байт-кода. Следовательно, если запускаемая программа либо используемая библиотека уже находятся в кэше, то они будут быстрее запускаться и работать.</p>
<p>Из такого описания кажется, что достаточно оставить эти службы работать, и они автоматически в фоне проделают всю работу, но это не так. Во-первых, эти службы не сканируют весь диск в поисках .NET программ - разработчик должен сделать это явно. Во-вторых, все <em>просьбы</em> добавить в кэш имеют приоритет.</p>
<p>Приоритетов всего 3:</p>
<ol>
<li>выполнить немедленно</li>
<li>отложить выполнение до завершения операций первого приоритета</li>
<li>отложить, и выполнить во время простоя компьютера</li>
</ol>
<p>Так вот, если задания с приоритетом 1 и 2 обрабатываются нормально, то задания 3-го приоритета могут вечно стоять в этой очереди. Поэтому хорошо бы форсировать этот процесс.</p>
<p><!--more--></p>
<p>MSDN нам <a href="http://msdn.microsoft.com/ru-ru/library/6t9t5wcf.aspx" target="_blank">говорит</a>, что <em>тянуть за ниточки</em> можно при помощи <strong>Ngen.exe</strong>.</p>
<p class="note">Генератор образов в машинном коде (Ngen.exe) — это средство повышения быстродействия управляемых приложений. Ngen.exe создает образы в машинном коде, представляющие собой файлы, содержащие компилированный специфический для процессора машинный код, и устанавливает их в кэш образов в машинном коде на локальном компьютере. Среда выполнения может использовать образы в машинном коде, находящиеся в кэше, вместо использования JIT-компилятора для компиляции исходной сборки.</p>
<p>Ngen.exe лежит в<br />
<code>%WINDIR%\Microsoft.NET\Framework\&lt;версия&gt;\</code><br />
для 32bit систем, и в<br />
<code>%WINDIR%\Microsoft.NET\Framework64\&lt;версия&gt;\</code><br />
для 64bit систем.</p>
<p>Запускать всегда стоит Ngen.exe из последней версии .NET Framework (если в ней есть Ngen.exe). Если у вас 64bit система, то вам вначале надо запустить 32bit версию Ngen.exe, а затем 64bit. Одновременно запускать 32bit и 64bit версии нельзя!</p>
<p>Если количество ядер в вашей системе два и более, то Ngen.exe можно запустить в любое время - он полностью загрузит только 1 ядро (это справедливо для текущей версии .NET - v4.0.30319).</p>
<p>Теперь осталось вызвать Ngen.exe от админа так:</p>
<pre>ngen.exe executeQueuedItems</pre>
<p>Также, иногда стоит запускать обновление всего кэша:</p>
<pre>ngen.exe update</pre>
<p>Обычно после обновления .NET Framework запускается обновление кэша, и установщик обновления ждет, пока оно не закончится. Но установщик не будет ждать вечно, у него есть таймер, и, если обновление кэша не уложилось в отведенное время, то выдается ошибка и все откатывается. Чтобы установить такие обновления, надо во время установки, при появлении процесса Ngen.exe, убить его. После завершения установки обновления надо будет выполнить вручную отложенные операции, т.е. запустить Ngen.exe от админа:</p>
<pre>ngen.exe executeQueuedItems</pre>
<p>P.S. <a href="http://daisaev.blogspot.com/2009/06/net-runtime-optimization-service.html" target="_blank">Вот</a> еще статья на эту же тему</p>

